// Connect/disconnect handlers
tbody.addEventListener('click', async e => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const id = btn.dataset.id;
  const action = btn.dataset.action;
  const device = knownDevices.find(d => d.id === id);
  if (!device) return;

  if (action === 'connect') {
    try {
      log(`Connecting to ${device.name || id}...`);
      device.addEventListener('gattserverdisconnected', () => {
        log(`${device.name || id} disconnected`);
        renderTable();
      });
      await device.gatt.connect();
      log(`Connected to ${device.name || id}`);
    } catch (err) {
      log(`Connect failed: ${err.message}`);
    }
  } else if (action === 'disconnect') {
    try {
      device.gatt.disconnect();
      log(`Disconnected from ${device.name || id}`);
    } catch (err) {
      log(`Disconnect failed: ${err.message}`);
    }
  }
  renderTable();
});

// Initial check
if (!navigator.bluetooth) {
  log('Web Bluetooth API not supported in this browser.');
} else {
  refreshDevices();
}
