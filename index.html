<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluetooth Device List Demo</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f6f8fb; color:#111; padding:2rem; }
    .card { background:#fff; padding:1.25rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08); max-width:700px; margin:auto; }
    h1 { font-size:1.25rem; margin-top:0; }
    button { padding:.6rem 1rem; border:0; border-radius:8px; background:#0366d6; color:white; cursor:pointer; margin-right:.5rem; }
    button.secondary { background:#eef2ff; color:#0366d6; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th,td { text-align:left; padding:.5rem; border-bottom:1px solid #e2e8f0; }
    th { background:#f1f5f9; font-weight:600; }
    pre { background:#0b1220; color:#e6f0ff; padding:.75rem; border-radius:8px; font-size:.9rem; max-height:240px; overflow:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Bluetooth Device List (Web Bluetooth API)</h1>
    <p style="font-size:.9rem;color:#555;">Works on HTTPS/localhost in Chromium browsers. You can pick multiple devices and reconnect later.</p>

    <button id="addDeviceBtn">Add New Device</button>
    <button id="refreshBtn" class="secondary">Refresh Known Devices</button>

    <table id="deviceTable">
      <thead>
        <tr><th>Name</th><th>ID</th><th>Connected</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 style="font-size:1rem;margin-top:1rem;">Log</h2>
    <pre id="log"></pre>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const logEl = $('#log');
    const tbody = $('#deviceTable tbody');

    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `${t} — ${msg}\n` + logEl.textContent;
    }

    // Keep references to devices so we can reconnect
    let knownDevices = [];

    async function refreshDevices(){
      try {
        const devices = await navigator.bluetooth.getDevices();
        knownDevices = devices;
        renderTable();
        log(`Found ${devices.length} previously paired device(s).`);
      } catch(err){
        log(`Error listing devices: ${err}`);
      }
    }

    function renderTable(){
      tbody.innerHTML = '';
      if (knownDevices.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">No devices known yet.</td></tr>';
        return;
      }
      for (const dev of knownDevices){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${dev.name || '(no name)'}</td>
          <td>${dev.id}</td>
          <td>${dev.gatt && dev.gatt.connected ? '✅' : '❌'}</td>
          <td>
            ${dev.gatt && dev.gatt.connected
              ? `<button class="secondary" data-id="${dev.id}" data-action="disconnect">Disconnect</button>`
              : `<button class="secondary" data-id="${dev.id}" data-action="connect">Connect</button>`}
          </td>`;
        tbody.appendChild(tr);
      }
    }

    // When the user clicks "Add New Device"
    $('#addDeviceBtn').addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service'] // example optional service
        });
        log(`Added device: ${device.name || '(no name)'} (${device.id})`);
        knownDevices.push(device);
        renderTable();
      } catch(err){
        log(`Add failed: ${err.message}`);
      }
    });

    // Refresh known devices
    $('#refreshBtn').addEventListener('click', refreshDevices);

    // Connect/disconnect handlers
    tbody.addEventListener('click', async e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const device = knownDevices.find(d => d.id === id);
      if (!device) return;

      if (action === 'connect'){
        try {
          log(`Connecting to ${device.name || id}...`);
          device.addEventListener('gattserverdisconnected', () => {
            log(`${device.name || id} disconnected`);
            renderTable();
          });
          await device.gatt.connect();
          log(`Connected to ${device.name || id}`);
        } catch(err){
          log(`Connect failed: ${err.message}`);
        }
      } else if (action === 'disconnect'){
        try {
          device.gatt.disconnect();
          log(`Disconnected from ${device.name || id}`);
        } catch(err){
          log(`Disconnect failed: ${err.message}`);
        }
      }
      renderTable();
    });
w
    // Initial check
    if (!navigator.bluetooth){
      log('Web Bluetooth API not supported in this browser.');
    } else {
      refreshDevices();
    }
  </script>
</body>
</html>
